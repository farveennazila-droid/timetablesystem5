<!DOCTYPE html>
<html>
<head>
    <title>Admin Panel - Manage Data</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <style>
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .btn-success {
            background: #27ae60;
        }
        .btn-success:hover {
            background: #229954;
        }
        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
        }
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        .form-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .form-section h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table thead {
            background: #34495e;
            color: white;
        }
        table th, table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        table tbody tr:hover {
            background: #f4f6f8;
        }
        .btn-delete {
            background: #e74c3c;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-delete:hover {
            background: #c0392b;
        }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>Admin</h2>
    <a href="/dashboard">Dashboard</a>
    <a href="/admin" style="color: #3498db;">Manage Data</a>
    <a href="#" onclick="logout(); return false;">Logout</a>
</div>

<div class="main">
    <h1>Admin Panel - Manage Data</h1>

    <!-- Add Faculty Section -->
    <div class="form-section">
        <h3>Add Faculty</h3>
        <div id="faculty-message" class="message"></div>
        <form onsubmit="addFaculty(event)">
            <div class="form-group">
                <label>Faculty Name:</label>
                <input type="text" id="faculty-name" placeholder="e.g., Dr. John Smith" required>
            </div>
            <div class="form-group">
                <label>Department:</label>
                <input type="text" id="faculty-dept" placeholder="e.g., Computer Science" required>
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="faculty-email" placeholder="e.g., john@university.edu">
            </div>
            <button type="submit" class="btn btn-success">Add Faculty</button>
        </form>

        <h4>Current Faculty</h4>
        <table id="faculty-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Department</th>
                    <th>Email</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="faculty-list">
                <tr><td colspan="4">Loading...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- Add Classroom Section -->
    <div class="form-section">
        <h3>Add Classroom</h3>
        <div id="room-message" class="message"></div>
        <form onsubmit="addClassroom(event)">
            <div class="form-group">
                <label>Room Number:</label>
                <input type="text" id="room-number" placeholder="e.g., A101" required>
            </div>
            <div class="form-group">
                <label>Capacity:</label>
                <input type="number" id="room-capacity" placeholder="e.g., 30" min="1" required>
            </div>
            <div class="form-group">
                <label>Location:</label>
                <input type="text" id="room-location" placeholder="e.g., Building A" required>
            </div>
            <button type="submit" class="btn btn-success">Add Classroom</button>
        </form>

        <h4>Current Classrooms</h4>
        <table id="room-table">
            <thead>
                <tr>
                    <th>Room Number</th>
                    <th>Capacity</th>
                    <th>Location</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="room-list">
                <tr><td colspan="4">Loading...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- Create & Publish Timetable Section -->
    <div class="form-section">
        <h3>üìÖ Create & Manage Timetable</h3>
        <div id="timetable-message" class="message"></div>
        <form onsubmit="addTimetableEntry(event)">
            <div class="form-group">
                <label>Day:</label>
                <select id="timetable-day" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">Select Day</option>
                    <option value="Monday">Monday</option>
                    <option value="Tuesday">Tuesday</option>
                    <option value="Wednesday">Wednesday</option>
                    <option value="Thursday">Thursday</option>
                    <option value="Friday">Friday</option>
                    <option value="Saturday">Saturday</option>
                </select>
            </div>
            <div class="form-group">
                <label>Period:</label>
                <input type="number" id="timetable-period" placeholder="e.g., 1" min="1" max="10" required>
            </div>
            <div class="form-group">
                <label>Subject:</label>
                <select id="timetable-subject" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">Select Subject</option>
                </select>
            </div>
            <div class="form-group">
                <label>Faculty:</label>
                <select id="timetable-faculty" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">Select Faculty</option>
                </select>
            </div>
            <div class="form-group">
                <label>Room:</label>
                <select id="timetable-room" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">Select Room</option>
                </select>
            </div>
            <button type="submit" class="btn btn-success">Add to Timetable</button>
        </form>

        <h4>Current Timetable</h4>
        <table id="timetable-table">
            <thead>
                <tr>
                    <th>Day</th>
                    <th>Period</th>
                    <th>Subject</th>
                    <th>Faculty</th>
                    <th>Room</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="timetable-list">
                <tr><td colspan="7">Loading...</td></tr>
            </tbody>
        </table>

        <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button type="button" class="btn btn-success" onclick="publishTimetable()" style="flex: 1;">
                üöÄ Publish Timetable
            </button>
            <button type="button" class="btn" onclick="clearTimetable()" style="flex: 1; background: #e74c3c;">
                üóëÔ∏è Clear All Entries
            </button>
        </div>
    </div>

</div>

<script>
// Load faculty list on page load
document.addEventListener('DOMContentLoaded', function() {
    loadFacultyList();
    loadClassroomList();
    loadSubjects();
    loadTimetable();
    populateFacultyDropdown();
    populateRoomDropdown();
    populateSubjectDropdown();
    
    // Refresh timetable every 3 seconds for real-time updates
    setInterval(loadTimetable, 3000);
});

function loadFacultyList() {
    fetch('/api/faculty')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('faculty-list');
            tbody.innerHTML = '';
            if (Array.isArray(data) && data.length > 0) {
                data.forEach(faculty => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${faculty[1] || faculty.name}</td>
                            <td>${faculty[2] || faculty.department}</td>
                            <td>${faculty[3] || faculty.email || '-'}</td>
                            <td><button class="btn-delete" onclick="deleteFaculty(${faculty[0] || faculty.id})">Delete</button></td>
                        </tr>
                    `;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="4">No faculty added yet</td></tr>';
            }
        })
        .catch(error => console.error('Error:', error));
}

function loadClassroomList() {
    fetch('/api/classrooms')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('room-list');
            tbody.innerHTML = '';
            if (Array.isArray(data) && data.length > 0) {
                data.forEach(room => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${room[1] || room.room_number}</td>
                            <td>${room[2] || room.capacity}</td>
                            <td>${room[3] || room.location}</td>
                            <td><button class="btn-delete" onclick="deleteClassroom(${room[0] || room.id})">Delete</button></td>
                        </tr>
                    `;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="4">No classrooms added yet</td></tr>';
            }
        })
        .catch(error => console.error('Error:', error));
}

function addFaculty(event) {
    event.preventDefault();

    const name = document.getElementById('faculty-name').value;
    const department = document.getElementById('faculty-dept').value;
    const email = document.getElementById('faculty-email').value;

    fetch('/api/faculty', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            name: name,
            department: department,
            email: email
        })
    })
    .then(response => response.json())
    .then(data => {
        const msgDiv = document.getElementById('faculty-message');
        if (data.status === 'success') {
            msgDiv.textContent = 'Faculty added successfully!';
            msgDiv.className = 'message success';
            document.getElementById('faculty-name').value = '';
            document.getElementById('faculty-dept').value = '';
            document.getElementById('faculty-email').value = '';
            loadFacultyList();
        } else {
            msgDiv.textContent = 'Error: ' + (data.message || 'Failed to add faculty');
            msgDiv.className = 'message error';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        const msgDiv = document.getElementById('faculty-message');
        msgDiv.textContent = 'Error adding faculty';
        msgDiv.className = 'message error';
    });
}

function addClassroom(event) {
    event.preventDefault();

    const room_number = document.getElementById('room-number').value;
    const capacity = parseInt(document.getElementById('room-capacity').value);
    const location = document.getElementById('room-location').value;

    fetch('/api/classrooms', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            room_number: room_number,
            capacity: capacity,
            location: location
        })
    })
    .then(response => response.json())
    .then(data => {
        const msgDiv = document.getElementById('room-message');
        if (data.status === 'success') {
            msgDiv.textContent = 'Classroom added successfully!';
            msgDiv.className = 'message success';
            document.getElementById('room-number').value = '';
            document.getElementById('room-capacity').value = '';
            document.getElementById('room-location').value = '';
            loadClassroomList();
        } else {
            msgDiv.textContent = 'Error: ' + (data.message || 'Failed to add classroom');
            msgDiv.className = 'message error';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        const msgDiv = document.getElementById('room-message');
        msgDiv.textContent = 'Error adding classroom';
        msgDiv.className = 'message error';
    });
}

function deleteFaculty(id) {
    if (confirm('Are you sure you want to delete this faculty?')) {
        fetch(`/api/faculty/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                loadFacultyList();
            }
        })
        .catch(error => console.error('Error:', error));
    }
}

function deleteClassroom(id) {
    if (confirm('Are you sure you want to delete this classroom?')) {
        fetch(`/api/classrooms/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                loadClassroomList();
            }
        })
        .catch(error => console.error('Error:', error));
    }
}

function logout() {
    window.location.href = "/";
}

// ========== TIMETABLE MANAGEMENT FUNCTIONS ==========

function loadSubjects() {
    fetch('/api/subject')
        .then(response => response.json())
        .then(data => {
            if (Array.isArray(data) && data.length > 0) {
                populateSubjectDropdown();
            }
        })
        .catch(error => console.error('Error loading subjects:', error));
}

function populateSubjectDropdown() {
    fetch('/api/subject')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('timetable-subject');
            select.innerHTML = '<option value="">Select Subject</option>';
            if (Array.isArray(data)) {
                data.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject[2] || subject.subject_name;
                    option.textContent = subject[2] || subject.subject_name;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => console.error('Error populating subjects:', error));
}

function populateFacultyDropdown() {
    fetch('/api/faculty')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('timetable-faculty');
            select.innerHTML = '<option value="">Select Faculty</option>';
            if (Array.isArray(data)) {
                data.forEach(faculty => {
                    const option = document.createElement('option');
                    option.value = faculty[1] || faculty.name;
                    option.textContent = faculty[1] || faculty.name;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => console.error('Error populating faculty:', error));
}

function populateRoomDropdown() {
    fetch('/api/classrooms')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('timetable-room');
            select.innerHTML = '<option value="">Select Room</option>';
            if (Array.isArray(data)) {
                data.forEach(room => {
                    const option = document.createElement('option');
                    option.value = room[1] || room.room_name;
                    option.textContent = room[1] || room.room_name;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => console.error('Error populating rooms:', error));
}

function loadTimetable() {
    fetch('/api/timetable')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('timetable-list');
            tbody.innerHTML = '';
            
            if (Array.isArray(data) && data.length > 0) {
                data.forEach(entry => {
                    const id = entry[0];
                    const day = entry[1] || '-';
                    const period = entry[2] || '-';
                    const subject = entry[3] || '-';
                    const faculty = entry[4] || '-';
                    const room = entry[5] || '-';
                    const published = entry[6] === 1 || entry[6] === true ? 'Published' : 'Draft';
                    const statusColor = published === 'Published' ? 'color: #27ae60; font-weight: bold;' : 'color: #f39c12; font-weight: bold;';
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${day}</td>
                            <td>${period}</td>
                            <td>${subject}</td>
                            <td>${faculty}</td>
                            <td>${room}</td>
                            <td style="${statusColor}">${published}</td>
                            <td><button class="btn-delete" onclick="deleteTimetableEntry(${id})">Delete</button></td>
                        </tr>
                    `;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No timetable entries yet</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error loading timetable:', error);
            document.getElementById('timetable-list').innerHTML = '<tr><td colspan="7" style="text-align: center; color: #e74c3c;">Error loading timetable</td></tr>';
        });
}

function addTimetableEntry(event) {
    event.preventDefault();

    const day = document.getElementById('timetable-day').value;
    const period = parseInt(document.getElementById('timetable-period').value);
    const subject = document.getElementById('timetable-subject').value;
    const faculty = document.getElementById('timetable-faculty').value;
    const room = document.getElementById('timetable-room').value;

    if (!day || !period || !subject || !faculty || !room) {
        showTimetableMessage('All fields are required', 'error');
        return;
    }

    fetch('/api/timetable', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            day: day,
            period: period,
            subject: subject,
            faculty: faculty,
            room: room
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success' || data.id) {
            showTimetableMessage('Timetable entry added successfully!', 'success');
            document.getElementById('timetable-day').value = '';
            document.getElementById('timetable-period').value = '';
            document.getElementById('timetable-subject').value = '';
            document.getElementById('timetable-faculty').value = '';
            document.getElementById('timetable-room').value = '';
            loadTimetable();
        } else {
            showTimetableMessage('Error: ' + (data.message || 'Failed to add entry'), 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showTimetableMessage('Error adding timetable entry', 'error');
    });
}

function deleteTimetableEntry(id) {
    if (confirm('Are you sure you want to delete this timetable entry?')) {
        fetch(`/api/timetable/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showTimetableMessage('Entry deleted successfully', 'success');
                loadTimetable();
            } else {
                showTimetableMessage('Error deleting entry', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showTimetableMessage('Error deleting entry', 'error');
        });
    }
}

function publishTimetable() {
    if (confirm('‚ö†Ô∏è Publishing the timetable will make it visible to all students. Continue?')) {
        fetch('/api/timetable/publish', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showTimetableMessage('‚úÖ Timetable published successfully! Students can now see their schedules.', 'success');
                loadTimetable();
            } else {
                showTimetableMessage('Error publishing timetable: ' + (data.message || ''), 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showTimetableMessage('Error publishing timetable', 'error');
        });
    }
}

function clearTimetable() {
    if (confirm('‚ö†Ô∏è This will delete ALL timetable entries. Are you sure?')) {
        fetch('/api/timetable/clear', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showTimetableMessage('All timetable entries cleared', 'success');
                loadTimetable();
            } else {
                showTimetableMessage('Error clearing timetable', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showTimetableMessage('Error clearing timetable', 'error');
        });
    }
}

function showTimetableMessage(message, type) {
    const msgDiv = document.getElementById('timetable-message');
    msgDiv.textContent = message;
    msgDiv.className = 'message ' + type;
    setTimeout(() => {
        msgDiv.className = 'message';
    }, 5000);
}
</script>

</body>
</html>
